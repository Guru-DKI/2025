<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PJJ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/16rll5zsRdwTbR3nF_NmPKwY51tg4tnOn">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --primary-color: #4a90e2;
            --success-color: #50e3c2;
            --danger-color: #e74c3c;
            --warning-color: #f5a623;
            --info-color: #8e44ad;
            --whatsapp-color: #25D366;
            --bg-color: #f7f9fc;
            --card-bg-color: #ffffff;
            --text-color: #333;
            --text-light-color: #888;
            --border-color: #e0e6ed;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .app-container { width: 100%; height: 100vh; padding: 2rem; display: flex; flex-direction: column; transition: opacity 0.5s ease-in-out; }
        .app-container.hidden { opacity: 0; pointer-events: none; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        .app-header h1 { font-size: 2rem; color: var(--text-color); }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .header-actions .btn { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; padding: 0.75rem 1.5rem; }
        .table-wrapper { flex-grow: 1; overflow: auto; background-color: var(--card-bg-color); border-radius: 12px; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; min-width: 1350px; } /* Lebar minimum disesuaikan */
		th, td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: normal; }
        th { background-color: #f9fafb; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #eff6ff; }
        td a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        td a:hover { text-decoration: underline; }
        .btn { border: none; border-radius: 8px; cursor: pointer; font-family: var(--font-family); font-weight: 600; transition: all 0.2s ease; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .actions { display: flex; gap: 0.75rem; }
        .btn-icon { width: 40px; height: 40px; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
        .btn-edit { background-color: var(--warning-color); color: white; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; font-size: 1.2rem; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
		    background-color: var(--card-bg-color);
		    padding: 2.5rem;
		    border-radius: 16px;
		    width: 90%;
		    max-width: 800px;
		    position: relative;
		    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
		    transform: scale(0.95);
		    transition: transform 0.3s ease;
		    max-height: 90vh;
		    overflow-y: auto;
		    /* Baris baru untuk Firefox & IE */
		    scrollbar-width: none;  
		    -ms-overflow-style: none;
		}
        .modal.visible .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 2rem; color: var(--text-light-color); cursor: pointer; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea { padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-family); }
        textarea { resize: vertical; min-height: 100px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        form .btn { grid-column: 1 / -1; padding: 1rem; font-size: 1rem; }
        .small-modal .modal-content { max-width: 450px; }
        .small-modal form { grid-template-columns: 1fr; }
        #passwordError, .notification-message, .confirmation-message { text-align: center; margin-bottom: 1.5rem; font-size: 1.1rem; }
        .confirmation-buttons { display: flex; justify-content: center; gap: 1rem; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #loader-overlay.visible { opacity: 1; pointer-events: auto; }
        .spinner { border: 5px solid #e0e6ed; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader-overlay"><div class="spinner"></div></div>
    <div id="passwordModal" class="modal small-modal visible"></div>
    
    <main id="pageContent" class="app-container hidden">
        <header class="app-header">
            <h1><i class="fas fa-database" style="color: var(--primary-color);"></i> Database Pembelajaran</h1>
            <div class="header-actions">
                <a href="PJJDKI.html" class="btn btn-info">
                    <i class="fas fa-chalkboard-teacher"></i> Guru
                </a>
                <button id="showAddModalBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tambah Data
                </button>
            </div>
        </header>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Kelas</th><th>Pelajaran</th><th>Tujuan Pembelajaran</th><th>Materi</th><th>RPP</th><th>Video</th><th>Media</th>
                        <th>Strategi</th> <th title="WhatsApp"><i class="fab fa-whatsapp"></i></th> <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </main>
    
    <div id="dataModal" class="modal"></div>
    <div id="notificationModal" class="modal small-modal"></div>
    <div id="confirmationModal" class="modal small-modal"></div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbx-wAVXSWhY5D9alr0rahxNLBfN09Wnv0AbMxM4w4pTnDGl-4Ysro6YfjV6ISA8qkFH/exec';
        
        const pageContent = document.getElementById('pageContent');
        const loader = document.getElementById('loader-overlay');
        const dataTableBody = document.getElementById('dataTableBody');
        const passwordModal = document.getElementById('passwordModal');
        const dataModal = document.getElementById('dataModal');
        const notificationModal = document.getElementById('notificationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        
        const showLoader = (show) => loader.classList.toggle('visible', show);
        const showModal = (modal, show) => modal.classList.toggle('visible', show);

        function showNotification(message, type = 'success') {
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            const color = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
            notificationModal.innerHTML = `
                <div class="modal-content">
                    <h2 style="color: ${color}; margin-bottom: 1rem;"><i class="fas ${icon}"></i> Notifikasi</h2>
                    <p class="notification-message">${message}</p>
                    <button id="notificationOkBtn" class="btn btn-primary">OK</button>
                </div>
            `;
            showModal(notificationModal, true);
            return new Promise(resolve => {
                document.getElementById('notificationOkBtn').onclick = () => {
                    showModal(notificationModal, false);
                    resolve();
                };
            });
        }

        function showConfirmation(message) {
            confirmationModal.innerHTML = `
                <div class="modal-content">
                    <h2 style="color: var(--warning-color); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Konfirmasi</h2>
                    <p class="confirmation-message">${message}</p>
                    <div class="confirmation-buttons">
                        <button id="confirmYesBtn" class="btn" style="background-color: var(--danger-color); color: white;">Ya, Lanjutkan</button>
                        <button id="confirmNoBtn" class="btn" style="background-color: #ccc;">Batal</button>
                    </div>
                </div>
            `;
            showModal(confirmationModal, true);
            return new Promise(resolve => {
                document.getElementById('confirmYesBtn').onclick = () => { showModal(confirmationModal, false); resolve(true); };
                document.getElementById('confirmNoBtn').onclick = () => { showModal(confirmationModal, false); resolve(false); };
            });
        }

        passwordModal.innerHTML = `<div class="modal-content"><h2><i class="fas fa-lock" style="margin-right: 10px;"></i> Autentikasi</h2><form id="passwordForm"><div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div><button type="submit" class="btn btn-primary">Masuk</button></form><p id="passwordError" style="color: var(--danger-color); margin-top: 1rem; display: none;">Password salah!</p></div>`;
        document.getElementById('passwordForm').addEventListener('submit', e => { e.preventDefault(); if (document.getElementById('password').value === 'PJJ2025') { showModal(passwordModal, false); pageContent.classList.remove('hidden'); fetchData(); } else { document.getElementById('passwordError').style.display = 'block'; } });


        async function fetchData() {
            showLoader(true);
            try {
                const response = await fetch(scriptURL);
                const data = await response.json();
                const tableData = data.slice(1);
                dataTableBody.innerHTML = '';
                tableData.forEach((rowData, index) => {
                    if (rowData.every(cell => cell === "")) return;
                    
                    // PERUBAHAN: Phone sekarang di indeks 9
                    const phone = rowData[9] || '';
                    let phoneCell = '<td>-</td>';
                    if (phone && String(phone).startsWith('62')) {
                        phoneCell = `<td><a href="https://wa.me/${phone}" target="_blank" class="btn btn-icon btn-whatsapp" title="${phone}"><i class="fab fa-whatsapp"></i></a></td>`;
                    }
                    
                    const row = document.createElement('tr');
                    // PERUBAHAN: Tampilkan data hingga kolom ke-8 (Strategi)
                    row.innerHTML = `
                        ${rowData.slice(1, 9).map(cell => `<td>${String(cell).startsWith('http') ? `<a href="${cell}" target="_blank">Lihat Link</a>` : cell}</td>`).join('')}
                        ${phoneCell}
                        <td class="actions">
                            <button class="btn btn-icon btn-edit" onclick='openDataModal("edit", ${index + 2}, ${JSON.stringify(rowData)})'><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-icon btn-delete" onclick='deleteData(${index + 2})'><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });
            } catch (error) { 
                await showNotification('Gagal memuat data. Periksa koneksi Anda.', 'error');
            } 
            finally { showLoader(false); }
        }

        function getFormHtml(mode, data = {}) {
            const isEdit = mode === 'edit';
            const title = isEdit ? 'Edit Data' : 'Tambah Data Baru';
            const icon = isEdit ? 'fa-edit' : 'fa-plus-circle';
            
            // --- LOGIKA BARU UNTUK MEMBACA DATA STRATEGI ---
            let strategiPilihan = '';
            let strategiTeks = '';
            if (data.Strategi) {
                const parts = String(data.Strategi).split(': ');
                strategiPilihan = parts[0];
                strategiTeks = parts.slice(1).join(': ');
            }
            const strategiOptions = ['PJJ', 'Hybrid', 'Tatap Muka'].map(o => `<option value="${o}" ${strategiPilihan === o ? 'selected' : ''}>${o}</option>`).join('');
            // --- AKHIR LOGIKA BARU ---

            const kelasOptions = ['1', '2', '3', '4', '5', '6'].map(n => `<option value="Kelas ${n}" ${data.Kelas === `Kelas ${n}` ? 'selected' : ''}>Kelas ${n}</option>`).join('');
            const pelajaranOptions = ['Pendidikan Agama Islam','Pendidikan Agama Kristen','Pendidikan Agama Katholik','Pendidikan Agama Hindu','Pendidikan Agama Budha','Pendidikan Agama Konghucu','Pendidikan Pancasila','Bahasa Indonesia','Matematika','Ilmu Pengetahuan Alam dan Sosial','Seni dan Budaya','Pendidikan Jasmani Olahraga dan Kesehatan','Pendidikan Lingkungan dan Budaya Jakarta','Bahasa Inggris','Koding dan Kecerdasan Artifisial','Mulok'].map(p => `<option value="${p}" ${data.Pelajaran === p ? 'selected' : ''}>${p}</option>`).join('');


            return `
                <div class="modal-content">
                    <button class="close-button" onclick="showModal(dataModal, false)">×</button>
                    <h2><i class="fas ${icon}" style="color: var(--primary-color);"></i> ${title}</h2>
                    <form id="dataForm">
                        ${isEdit ? `<input type="hidden" name="rowId" value="${data.rowId}">` : ''}
                        <div class="form-group"><label>Kelas</label><select name="Kelas" required>${kelasOptions}<option value="Lainnya">Lainnya</option></select></div>
                        <div class="form-group"><label>Pelajaran</label><select name="Pelajaran" required>${pelajaranOptions}</select></div>
                        <div class="form-group full-width"><label>Tujuan Pembelajaran</label><input type="text" name="Tujuan" value="${data.Tujuan || ''}" required></div>
                        <div class="form-group full-width"><label>Materi</label><input type="text" name="Materi" value="${data.Materi || ''}" required></div>
                        
                        <div class="form-group full-width">
                            <label>Strategi Pembelajaran</label>
                            <select name="StrategiPilihan" required style="margin-bottom: 1rem;">${strategiOptions}</select>
                            <textarea name="StrategiTeks" placeholder="Jelaskan strategi pembelajaran secara singkat..." required>${strategiTeks}</textarea>
                        </div>
                        
                        <div class="form-group"><label>Link RPP</label><input type="text" name="RPP" value="${data.RPP || ''}" required></div>
                        <div class="form-group"><label>Link Video</label><input type="text" name="Video" value="${data.Video || ''}" required></div>
                        <div class="form-group"><label>Link Media</label><input type="text" name="Media" value="${data.Media || ''}" required></div>
                        <div class="form-group">
                            <label>Nomor Telepon (WA)</label>
                            <input type="text" name="Phone" value="${data.Phone || ''}" placeholder="Contoh: 628123456789">
                        </div>
                        <button type="submit" class="btn btn-success">${isEdit ? '<i class="fas fa-save"></i> Simpan Perubahan' : '<i class="fas fa-plus"></i> Tambah Data'}</button>
                    </form>
                </div>
            `;
        }
        
        function openDataModal(mode, rowId = null, rowData = null) {
            let data = {};
            if (mode === 'edit') {
                // PERUBAHAN: Menyesuaikan indeks kolom
                data = { 
                    rowId, 
                    Kelas: rowData[1], 
                    Pelajaran: rowData[2], 
                    Tujuan: rowData[3], 
                    Materi: rowData[4], 
                    RPP: rowData[5], 
                    Video: rowData[6], 
                    Media: rowData[7], 
                    Strategi: rowData[8], // <-- Data baru
                    Phone: rowData[9]    // <-- Indeks bergeser
                };
            }
            dataModal.innerHTML = getFormHtml(mode, data);
            showModal(dataModal, true);
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
        }

        document.getElementById('showAddModalBtn').onclick = () => openDataModal('add');

        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const isEdit = formData.has('rowId');
            formData.append('action', isEdit ? 'update' : 'insert');

            showLoader(true);
            showModal(dataModal, false);

            try {
                const response = await fetch(scriptURL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.result !== 'success') throw new Error(result.message || 'Operasi gagal');
                await showNotification(`Data berhasil ${isEdit ? 'diperbarui' : 'disimpan'}!`, 'success');
                fetchData();
            } catch (error) {
                await showNotification(`Error: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function deleteData(rowId) {
            const confirmed = await showConfirmation('Anda yakin ingin menghapus data ini secara permanen?');
            if (confirmed) {
                showLoader(true);
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('rowId', rowId);
                try {
                    const response = await fetch(scriptURL, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.result !== 'success') throw new Error(result.message);
                    await showNotification('Data telah berhasil dihapus.', 'success');
                    fetchData();
                } catch (error) {
                    await showNotification(`Gagal menghapus data: ${error.message}`, 'error');
                } finally {
                    showLoader(false);
                }
            }
        }
    </script>
</body>
</html>

